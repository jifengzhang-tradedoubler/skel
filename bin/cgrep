#!/bin/sh

FIND_ROOT="$TC_SRC_HOME"
UNWANTED="-name .hg -prune"

while getopts "d:f:" opt ; do
    case $opt in
        d) FIND_ROOT="$OPTARG" ;;
        f) FILE_FILTER="$FILE_FILTER ${FILE_FILTER:+-o} -name $OPTARG" ;;
    esac
done

find_grep () {
    # if [ -n "$FILE_FILTER" ] ; then
    #     FILE_FILTER=" \( $FILE_FILTER \)"
    # fi
    echo "find $FIND_ROOT $UNWANTED -o \( $FILE_FILTER -print0 \) | xargs -0 grep --color -d skip -Pin $@"
    # find $FIND_ROOT $UNWANTED -o \( $FILE_FILTER -print0 \) | xargs -0 grep --color -d skip -Pin "$@"
    # works for more than one file but not "no file"
#    find $FIND_ROOT $UNWANTED -o \( \( $FILE_FILTER \) -print0 \) | xargs -0 grep --color -d skip -Pin "$@"
    # works-ish for one file but well for no file
    find $FIND_ROOT $UNWANTED -o \( $FILE_FILTER -print0 \) | xargs -0 grep --color -d skip -Pin "$@"
}

shift `expr $OPTIND - 1`

if [ $# -gt 1 ] ; then
    echo "Recursive search, will look for [arg N+1] in file with [arg N]."

fi

find_grep "$@"
